<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather Now – Single‑File</title>
  <meta name="description" content="A realistic weather web app. No API keys. Uses Open‑Meteo + OpenStreetMap Nominatim." />
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Recharts for Graphs -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Emoji, Noto Color Emoji, Apple Color Emoji, sans-serif; }
    .line-clamp-1 { display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden; }
  </style>
</head>
<body class="min-h-screen w-full bg-gradient-to-b from-sky-100 to-indigo-100 text-slate-800">
  <main class="mx-auto max-w-5xl px-4 py-6 sm:py-10">
    <header class="flex flex-col sm:flex-row sm:items-center gap-4 sm:gap-6">
      <div class="flex items-center gap-3">
        <span id="headerIcon" class="text-4xl sm:text-5xl" aria-hidden>☀️</span>
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Weather Now</h1>
      </div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-2">
        <button id="unitBtn" class="rounded-2xl bg-white/70 px-3 py-2 text-sm shadow hover:shadow-md transition font-medium" title="Toggle units">°C ↔︎ °F</button>
        <button id="geoBtn" class="rounded-2xl bg-indigo-600 text-white px-4 py-2 text-sm shadow hover:shadow-lg transition font-semibold">Use My Location</button>
      </div>
    </header>

    <div class="mt-6 relative">
      <input id="search" placeholder="Search city, postcode, or place…" class="w-full rounded-2xl border border-slate-200 bg-white/80 px-4 py-3 shadow focus:outline-none focus:ring-2 focus:ring-indigo-400" />
      <ul id="suggestions" class="hidden absolute z-20 mt-2 w-full max-h-72 overflow-auto rounded-xl border border-slate-200 bg-white/95 p-1 shadow-lg backdrop-blur"></ul>
    </div>

    <div id="error" class="hidden mt-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-red-700"></div>

    <section class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="lg:col-span-2 rounded-3xl bg-white/70 shadow p-5">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-sm uppercase tracking-wide text-slate-500">Currently</p>
            <h2 id="locName" class="text-xl font-semibold line-clamp-1" title="Pick a place">Pick a place</h2>
            <p id="tz" class="text-xs text-slate-500 mt-1"></p>
          </div>
          <div id="currentIcon" class="text-5xl">—</div>
        </div>

        <div class="mt-6 grid grid-cols-2 sm:grid-cols-3 gap-4">
          <div class="rounded-2xl border border-slate-200 bg-white/60 p-4 shadow-sm">
            <div class="text-xs uppercase tracking-wide text-slate-500">Temperature</div>
            <div id="temp" class="text-lg font-semibold mt-1">—</div>
            <div id="feels" class="text-xs text-slate-500 mt-1"></div>
          </div>
          <div class="rounded-2xl border border-slate-200 bg-white/60 p-4 shadow-sm">
            <div class="text-xs uppercase tracking-wide text-slate-500">Humidity</div>
            <div id="humidity" class="text-lg font-semibold mt-1">—</div>
          </div>
          <div class="rounded-2xl border border-slate-200 bg-white/60 p-4 shadow-sm">
            <div class="text-xs uppercase tracking-wide text-slate-500">Wind</div>
            <div id="wind" class="text-lg font-semibold mt-1">—</div>
            <div id="windDir" class="text-xs text-slate-500 mt-1"></div>
          </div>
          <div class="rounded-2xl border border-slate-200 bg-white/60 p-4 shadow-sm">
            <div class="text-xs uppercase tracking-wide text-slate-500">Precipitation</div>
            <div id="precip" class="text-lg font-semibold mt-1">—</div>
          </div>
          <div class="rounded-2xl border border-slate-200 bg-white/60 p-4 shadow-sm">
            <div class="text-xs uppercase tracking-wide text-slate-500">Conditions</div>
            <div id="cond" class="text-lg font-semibold mt-1">—</div>
          </div>
        </div>
        <div id="loading" class="hidden mt-6 animate-pulse text-sm text-slate-500">Loading weather…</div>
      </div>

      <div class="rounded-3xl bg-white/70 shadow p-5">
        <p class="text-sm uppercase tracking-wide text-slate-500">Next 7 days</p>
        <div id="daily" class="mt-4 grid grid-cols-7 gap-2 text-center"></div>
        <div id="dayDetails" class="mt-4"></div>
        <!-- Hourly Forecast Graph -->
        <div id="hourlyChart" class="mt-6 hidden"></div>
      </div>
    </section>

    <footer class="mt-10 text-xs text-slate-500">Data: Open‑Meteo & OpenStreetMap Nominatim. No API key required. Your location stays in your browser.</footer>
  </main>
  <script>
  const $ = (id) => document.getElementById(id);
  const fmt = (n, d=0) => Number.isFinite(n) ? n.toFixed(d) : '—';
  const toF = (c) => c * 9/5 + 32;

  const ICONS = { clear: '☀️', cloudy: '☁️', rain: '🌧️', snow: '❄️', thunder: '⛈️', fog: '🌫️', wind: '💨' };
  function codeToIcon(code){
    if ([0].includes(code)) return {icon:ICONS.clear,label:'Clear'};
    if ([1,2].includes(code)) return {icon:'🌤️',label:'Mainly clear'};
    if ([3].includes(code)) return {icon:ICONS.cloudy,label:'Cloudy'};
    if ([45,48].includes(code)) return {icon:ICONS.fog,label:'Fog'};
    if ([51,53,55,61,63,65,66,67,80,81,82].includes(code)) return {icon:ICONS.rain,label:'Rain'};
    if ([71,73,75,77,85,86].includes(code)) return {icon:ICONS.snow,label:'Snow'};
    if ([95,96,99].includes(code)) return {icon:ICONS.thunder,label:'Thunderstorm'};
    return {icon:ICONS.wind,label:'Windy'};
  }

  const state = {
    unit: localStorage.getItem('unit') || 'C',
    coords: JSON.parse(localStorage.getItem('coords') || 'null'),
    locName: localStorage.getItem('locName') || '',
    data: null,
    selectedDay: null,
  };

  function setUnit(u){ state.unit = u; localStorage.setItem('unit', u); render(); }
  function setCoords(c){ state.coords = c; localStorage.setItem('coords', JSON.stringify(c)); }
  function setLocName(n){ state.locName = n; localStorage.setItem('locName', n); }

  function showError(msg){ const el=$('error'); el.textContent = msg; el.classList.toggle('hidden', !msg); }
  function setLoading(v){ $('loading').classList.toggle('hidden', !v); }

  function displayUnit(c){ return state.unit === 'C' ? c : toF(c); }
  function prettyDate(iso){ return new Intl.DateTimeFormat(undefined,{weekday:'short',month:'short',day:'numeric'}).format(new Date(iso)); }

  // ------------ Weather ------------
  async function fetchWeather(lat, lon){
    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.searchParams.set('latitude', lat);
    url.searchParams.set('longitude', lon);
    url.searchParams.set('current', ['temperature_2m','apparent_temperature','wind_speed_10m','wind_direction_10m','relative_humidity_2m','precipitation','weather_code'].join(','));
    url.searchParams.set('daily', ['weather_code','temperature_2m_max','temperature_2m_min','precipitation_sum','wind_speed_10m_max','wind_direction_10m_dominant'].join(','));
    url.searchParams.set('hourly', ['temperature_2m','weather_code'].join(','));
    url.searchParams.set('timezone','auto');
    const res = await fetch(url.toString());
    if (!res.ok) throw new Error('Weather fetch failed');
    return res.json();
  }

  // ------------ Render ------------
  function render(){
    updateUnitBtn();
    const current = state.data?.current;
    const daily = state.data?.daily;
    const tz = state.data?.timezone;

    $('locName').textContent = state.locName || (state.coords ? `${fmt(state.coords.lat,2)}, ${fmt(state.coords.lon,2)}` : 'Pick a place');
    $('locName').title = state.locName;
    $('tz').textContent = tz ? `Timezone: ${tz}` : '';

    if (current){
      const { icon, label } = codeToIcon(current.weather_code);
      $('currentIcon').textContent = icon;
      $('headerIcon').textContent = icon;
      $('temp').textContent = `${fmt(displayUnit(current.temperature_2m),1)} °${state.unit}`;
      $('feels').textContent = `Feels like ${fmt(displayUnit(current.apparent_temperature),1)} °${state.unit}`;
      $('humidity').textContent = `${fmt(current.relative_humidity_2m)} %`;
      $('wind').textContent = `${fmt(current.wind_speed_10m,0)} km/h`;
      $('windDir').textContent = `${current.wind_direction_10m}°`;
      $('precip').textContent = `${fmt(current.precipitation,1)} mm`;
      $('cond').textContent = label;
    } else {
      $('currentIcon').textContent = '—';
    }

    const dailyEl = $('daily');
    dailyEl.innerHTML = '';
    if (daily && daily.time){
      daily.time.forEach((d, i)=>{
        const card = document.createElement('button');
        card.className = 'rounded-2xl border border-slate-200 bg-white/60 p-2 hover:bg-indigo-100 transition';
        card.innerHTML = `
          <div class="text-xs text-slate-500">${prettyDate(d)}</div>
          <div class="text-2xl">${codeToIcon(daily.weather_code[i]).icon}</div>
          <div class="text-xs mt-1">
            <span class="font-semibold">${fmt(displayUnit(daily.temperature_2m_max[i]),0)}°</span>
            <span class="text-slate-500"> / ${fmt(displayUnit(daily.temperature_2m_min[i]),0)}°</span>
          </div>
        `;
        card.addEventListener('click', ()=>{
          state.selectedDay = i;
          renderDayDetails();
          renderHourlyChart(i);
        });
        dailyEl.appendChild(card);
      });
    }
    renderDayDetails();
  }

  function renderDayDetails(){
    const detailBox = $('dayDetails');
    detailBox.innerHTML = '';
    const daily = state.data?.daily;
    if (daily && state.selectedDay != null){
      const i = state.selectedDay;
      const { icon, label } = codeToIcon(daily.weather_code[i]);
      detailBox.innerHTML = `
        <div class="rounded-2xl border border-slate-300 bg-white/80 p-4 shadow-md">
          <h3 class="font-semibold text-lg mb-2">${prettyDate(daily.time[i])}</h3>
          <div class="flex items-center gap-3 mb-3">
            <div class="text-4xl">${icon}</div>
            <div class="text-slate-700">${label}</div>
          </div>
          <p><strong>Max Temp:</strong> ${fmt(displayUnit(daily.temperature_2m_max[i]),1)} °${state.unit}</p>
          <p><strong>Min Temp:</strong> ${fmt(displayUnit(daily.temperature_2m_min[i]),1)} °${state.unit}</p>
          <p><strong>Precipitation:</strong> ${fmt(daily.precipitation_sum[i],1)} mm</p>
          <p><strong>Max Wind:</strong> ${fmt(daily.wind_speed_10m_max[i],0)} km/h (${daily.wind_direction_10m_dominant[i]}°)</p>
        </div>`;
    }
  }

  // ------------ Hourly Chart ------------
  function renderHourlyChart(dayIndex){
    const hourly = state.data?.hourly;
    if (!hourly) return;

    const startDate = state.data.daily.time[dayIndex];
    const dayTemps = [];

    hourly.time.forEach((t,i)=>{
      if (t.startsWith(startDate)){
        dayTemps.push({
          time: new Date(t).getHours() + ":00",
          temp: displayUnit(hourly.temperature_2m[i])
        });
      }
    });

    if (dayTemps.length===0) return;

    $('hourlyChart').classList.remove('hidden');

    const { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } = Recharts;

    ReactDOM.render(
      React.createElement(ResponsiveContainer, {width:"100%", height:250},
        React.createElement(LineChart, {data:dayTemps, margin:{top:10,right:20,left:0,bottom:0}},
          React.createElement(CartesianGrid, {strokeDasharray:"3 3"}),
          React.createElement(XAxis, {dataKey:"time"}),
          React.createElement(YAxis, {}),
          React.createElement(Tooltip, {}),
          React.createElement(Line, {type:"monotone", dataKey:"temp", stroke:"#4f46e5", strokeWidth:2})
        )
      ), $('hourlyChart')
    );
  }

  // ------------ Unit Toggle ------------
  function updateUnitBtn(){ $('unitBtn').textContent = `°${state.unit} ↔︎ °${state.unit==='C'?'F':'C'}`; }
  $('unitBtn').addEventListener('click', ()=>{ setUnit(state.unit==='C'?'F':'C'); updateUnitBtn(); });

  async function loadWeather(){
    if (!state.coords) return;
    showError(''); setLoading(true);
    try{
      const data = await fetchWeather(state.coords.lat, state.coords.lon);
      state.data = data; render();
    }catch(e){ showError(e?.message || 'Failed to load weather'); }
    finally{ setLoading(false); }
  }

  (function init(){
    updateUnitBtn(); render();
    if (state.coords) { loadWeather(); }
  })();
</script>
</body>
</html>
