<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dynamic Weather Forecast</title>
  <meta name="description" content="A beautiful, single-file weather forecast app using Open-Meteo and OpenStreetMap." />
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* Custom scrollbar for a cleaner look in Webkit browsers */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    /* Fallback for emoji icons in some Windows fonts */
    body { 
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Emoji, Noto Color Emoji, Apple Color Emoji, sans-serif; 
    }
    /* Simple fade-in animation */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }
  </style>
</head>
<body class="min-h-screen w-full bg-gradient-to-br from-cyan-500 to-blue-700 text-white font-sans">
  <main class="mx-auto max-w-6xl px-4 py-6 sm:py-8">

    <header class="flex flex-col sm:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <span id="headerIcon" class="text-4xl">🌦️</span>
        <h1 class="text-3xl font-bold tracking-tight">Weather Forecast</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="unitBtn" class="rounded-full bg-white/20 px-4 py-2 text-sm font-medium backdrop-blur-sm shadow-md transition hover:bg-white/30" title="Toggle temperature units">°C ↔︎ °F</button>
        <button id="geoBtn" class="rounded-full bg-white text-blue-600 px-4 py-2 text-sm font-semibold shadow-lg transition hover:bg-opacity-90">Use My Location</button>
      </div>
    </header>

    <div class="mt-6 relative">
      <input id="search" placeholder="Search for any city or place…" class="w-full rounded-full border-2 border-white/30 bg-white/20 px-5 py-3 text-white placeholder-white/70 shadow-lg backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-white/50" />
      <ul id="suggestions" class="hidden absolute z-20 mt-2 w-full max-h-72 overflow-auto rounded-2xl border border-white/20 bg-white/20 p-1 shadow-lg backdrop-blur-md"></ul>
    </div>
    
    <div id="error" class="hidden mt-4 rounded-xl bg-red-500/80 px-4 py-3 text-center font-semibold"></div>
    <div id="loading" class="hidden mt-4 animate-pulse text-center text-white/80">Loading weather data…</div>

    <section id="weatherDisplay" class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6 opacity-0 transition-opacity duration-500">
      
      <div class="lg:col-span-1 rounded-3xl bg-white/20 p-6 shadow-xl backdrop-blur-md">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-sm uppercase tracking-wider text-white/80">Current Weather</p>
            <h2 id="locName" class="text-2xl font-bold" title="Pick a place">Pick a place</h2>
            <p id="tz" class="text-xs text-white/70 mt-1"></p>
          </div>
          <div id="currentIcon" class="text-6xl -mt-2">--</div>
        </div>
        <div class="mt-6 text-center">
            <div id="temp" class="text-7xl font-extrabold tracking-tighter">--</div>
            <div id="feels" class="text-sm text-white/80"></div>
        </div>
        <hr class="my-6 border-white/20">
        <div class="grid grid-cols-2 gap-4 text-sm">
            <div class="flex items-center gap-2">💧 <span class="text-white/80">Humidity:</span><strong id="humidity">--</strong></div>
            <div class="flex items-center gap-2">💨 <span class="text-white/80">Wind:</span><strong id="wind">--</strong></div>
            <div class="flex items-center gap-2">🧭 <span class="text-white/80">Direction:</span><strong id="windDir">--</strong></div>
            <div class="flex items-center gap-2">💧 <span class="text-white/80">Precipitation:</span><strong id="precip">--</strong></div>
        </div>
        <div id="cond" class="mt-4 text-center font-medium text-lg">--</div>
      </div>
      
      <div class="lg:col-span-2 space-y-6">
        <div class="rounded-3xl bg-white/20 p-6 shadow-xl backdrop-blur-md">
            <h3 class="text-sm uppercase tracking-wider text-white/80 mb-4">7-Day Forecast</h3>
            <div id="daily" class="flex gap-3 overflow-x-auto pb-3 -mx-6 px-6">
                </div>
        </div>
        
        <div id="detailsContainer" class="space-y-6">
          <div id="dayDetails"></div>
          <div id="hourly"></div>
        </div>
      </div>

    </section>

    <footer class="mt-10 text-center text-xs text-white/60">
      Data provided by <a href="https://open-meteo.com/" target="_blank" class="underline">Open-Meteo</a> & <a href="https://openstreetmap.org/" target="_blank" class="underline">OpenStreetMap</a>.
    </footer>
  </main>

  <script>
    // ------------ State & Utilities ------------
    const $ = (id) => document.getElementById(id);
    const fmt = (n, d = 0) => (Number.isFinite(n) ? n.toFixed(d) : '--');
    const toF = (c) => c * 9 / 5 + 32;

    const ICONS = { clear: '☀️', cloudy: '☁️', rain: '🌧️', snow: '❄️', thunder: '⛈️', fog: '🌫️', wind: '💨' };
    const codeToIcon = (code) => {
        if ([0].includes(code)) return { icon: ICONS.clear, label: 'Clear Sky' };
        if ([1, 2].includes(code)) return { icon: '🌤️', label: 'Mainly Clear' };
        if ([3].includes(code)) return { icon: ICONS.cloudy, label: 'Cloudy' };
        if ([45, 48].includes(code)) return { icon: ICONS.fog, label: 'Fog' };
        if ([51, 53, 55, 61, 63, 65, 66, 67, 80, 81, 82].includes(code)) return { icon: ICONS.rain, label: 'Rain' };
        if ([71, 73, 75, 77, 85, 86].includes(code)) return { icon: ICONS.snow, label: 'Snow' };
        if ([95, 96, 99].includes(code)) return { icon: ICONS.thunder, label: 'Thunderstorm' };
        return { icon: ICONS.wind, label: 'Windy' };
    };

    const state = {
        unit: localStorage.getItem('unit') || 'C',
        coords: JSON.parse(localStorage.getItem('coords') || 'null'),
        locName: localStorage.getItem('locName') || '',
        data: null,
        selectedDay: 0,
    };

    const setUnit = (u) => { state.unit = u; localStorage.setItem('unit', u); render(); };
    const setCoords = (c) => { state.coords = c; localStorage.setItem('coords', JSON.stringify(c)); };
    const setLocName = (n) => { state.locName = n; localStorage.setItem('locName', n); };

    const showError = (msg) => { const el = $('error'); el.textContent = msg; el.classList.toggle('hidden', !msg); };
    const setLoading = (v) => { $('loading').classList.toggle('hidden', !v); };

    const displayUnit = (c) => (state.unit === 'C' ? c : toF(c));
    const prettyDate = (iso) => new Date(iso).toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' });

    // ------------ API Calls ------------
    async function geocode(q, signal) {
        const url = `https://nominatim.openstreetmap.org/search?q=${q}&format=json&addressdetails=1&limit=5`;
        const res = await fetch(url, { headers: { 'Accept-Language': navigator.language || 'en' }, signal });
        if (!res.ok) throw new Error('Geocoding failed');
        return res.json();
    }
    
    async function reverseGeocode(lat, lon) {
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=10`;
        const res = await fetch(url, { headers: { 'Accept-Language': navigator.language || 'en' } });
        if (!res.ok) throw new Error('Reverse geocoding failed');
        const j = await res.json();
        return j?.display_name || `${fmt(lat, 2)}, ${fmt(lon, 2)}`;
    }
    
    async function fetchWeather(lat, lon) {
        const url = new URL('https://api.open-meteo.com/v1/forecast');
        url.searchParams.set('latitude', lat);
        url.searchParams.set('longitude', lon);
        url.searchParams.set('current', 'temperature_2m,apparent_temperature,wind_speed_10m,wind_direction_10m,relative_humidity_2m,precipitation,weather_code');
        url.searchParams.set('daily', 'weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,wind_speed_10m_max,wind_direction_10m_dominant');
        url.searchParams.set('hourly', 'temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m,weather_code');
        url.searchParams.set('timezone', 'auto');
        const res = await fetch(url.toString());
        if (!res.ok) throw new Error('Weather fetch failed');
        return res.json();
    }

    // ------------ UI Event Listeners ------------
    let suggestAbort; let suggestTimer;
    $('search').addEventListener('input', (e) => {
        const q = e.target.value.trim();
        clearTimeout(suggestTimer);
        const ul = $('suggestions');
        if (!q || q.length < 3) { ul.innerHTML = ''; ul.classList.add('hidden'); return; }
        suggestTimer = setTimeout(async () => {
            try {
                suggestAbort?.abort();
                suggestAbort = new AbortController();
                const list = await geocode(q, suggestAbort.signal);
                ul.innerHTML = list.map(s => `<li><button class="block w-full text-left px-4 py-2 rounded-lg text-white hover:bg-white/20">${s.display_name}</button></li>`).join('');
                ul.querySelectorAll('button').forEach((btn, i) => btn.addEventListener('click', () => pickSuggestion(list[i])));
                ul.classList.toggle('hidden', list.length === 0);
            } catch (err) { if (err.name !== 'AbortError') console.warn(err); }
        }, 300);
    });
    
    const pickSuggestion = (s) => {
        $('search').value = '';
        const ul = $('suggestions');
        ul.innerHTML = '';
        ul.classList.add('hidden');
        setCoords({ lat: Number(s.lat), lon: Number(s.lon) });
        setLocName(s.display_name || s.name || 'Selected location');
        state.selectedDay = 0;
        loadWeather();
    };
    
    $('geoBtn').addEventListener('click', () => {
        if (!navigator.geolocation) { showError('Geolocation is not supported by your browser.'); return; }
        showError(''); setLoading(true);
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const { latitude: lat, longitude: lon } = pos.coords;
            setCoords({ lat, lon });
            try {
                const name = await reverseGeocode(lat, lon);
                setLocName(name);
            } catch {}
            state.selectedDay = 0;
            loadWeather();
        }, (err) => { setLoading(false); showError(err?.message || 'Could not get your location.'); });
    });

    const updateUnitBtn = () => { $('unitBtn').textContent = `°${state.unit} ↔︎ °${state.unit === 'C' ? 'F' : 'C'}`; };
    $('unitBtn').addEventListener('click', () => { setUnit(state.unit === 'C' ? 'F' : 'C'); updateUnitBtn(); });

    // ------------ Render Functions ------------
    const render = () => {
        if (!state.data) return;
        updateUnitBtn();
        renderCurrent();
        renderDaily();
        renderDetails();
        $('weatherDisplay').style.opacity = 1;
    };
    
    const renderCurrent = () => {
        const current = state.data.current;
        const { icon, label } = codeToIcon(current.weather_code);
        $('locName').textContent = state.locName || `${fmt(state.coords.lat, 2)}, ${fmt(state.coords.lon, 2)}`;
        $('tz').textContent = state.data.timezone;
        $('currentIcon').textContent = icon;
        $('headerIcon').textContent = icon;
        $('temp').innerHTML = `${fmt(displayUnit(current.temperature_2m), 0)}&deg;${state.unit}`;
        $('feels').textContent = `Feels like ${fmt(displayUnit(current.apparent_temperature), 0)}°`;
        $('humidity').textContent = `${fmt(current.relative_humidity_2m)}%`;
        $('wind').textContent = `${fmt(current.wind_speed_10m, 0)} km/h`;
        $('windDir').textContent = `${current.wind_direction_10m}°`;
        $('precip').textContent = `${fmt(current.precipitation, 1)} mm`;
        $('cond').textContent = label;
    };

    const renderDaily = () => {
        const daily = state.data.daily;
        const dailyEl = $('daily');
        dailyEl.innerHTML = daily.time.slice(0, 7).map((d, i) => `
            <button data-index="${i}" class="daily-card flex-shrink-0 w-24 rounded-2xl p-3 text-center transition ${state.selectedDay === i ? 'bg-white/30' : 'bg-white/10 hover:bg-white/20'}">
                <div class="font-semibold text-sm">${prettyDate(d)}</div>
                <div class="text-3xl my-1">${codeToIcon(daily.weather_code[i]).icon}</div>
                <div class="text-sm"><strong>${fmt(displayUnit(daily.temperature_2m_max[i]), 0)}°</strong> / ${fmt(displayUnit(daily.temperature_2m_min[i]), 0)}°</div>
            </button>
        `).join('');
        dailyEl.querySelectorAll('.daily-card').forEach(card => {
            card.addEventListener('click', () => {
                state.selectedDay = Number(card.dataset.index);
                renderDaily(); // Re-render to update selection style
                renderDetails();
                $('detailsContainer').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            });
        });
    };

    const renderDetails = () => {
        const dayDetailsEl = $('dayDetails');
        const hourlyEl = $('hourly');
        if (state.selectedDay == null) {
            dayDetailsEl.innerHTML = '';
            hourlyEl.innerHTML = '';
            return;
        }
        
        const i = state.selectedDay;
        const daily = state.data.daily;
        const { icon, label } = codeToIcon(daily.weather_code[i]);
        
        dayDetailsEl.innerHTML = `
            <div class="rounded-3xl bg-white/20 p-6 shadow-xl backdrop-blur-md fade-in">
                <h3 class="text-sm uppercase tracking-wider text-white/80">Details for ${new Date(daily.time[i]).toLocaleDateString(undefined, {weekday: 'long'})}</h3>
                <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4 items-center">
                    <div class="text-center">
                        <div class="text-4xl">${icon}</div>
                        <div class="font-semibold">${label}</div>
                    </div>
                    <p><strong>Max Temp:</strong> ${fmt(displayUnit(daily.temperature_2m_max[i]), 1)}°${state.unit}</p>
                    <p><strong>Min Temp:</strong> ${fmt(displayUnit(daily.temperature_2m_min[i]), 1)}°${state.unit}</p>
                    <p><strong>Precipitation:</strong> ${fmt(daily.precipitation_sum[i], 1)} mm</p>
                    <p><strong>Max Wind:</strong> ${fmt(daily.wind_speed_10m_max[i], 0)} km/h (${daily.wind_direction_10m_dominant[i]}°)</p>
                </div>
            </div>`;
        
        renderHourly(daily.time[i]);
    };

    const renderHourly = (dayIso) => {
        const hourly = state.data.hourly;
        const hourlyEl = $('hourly');
        
        const start = new Date(dayIso);
        const end = new Date(start);
        end.setDate(start.getDate() + 1);

        const hourlyContent = hourly.time.map((t, i) => ({ time: new Date(t), i }))
            .filter(({ time }) => time >= start && time < end)
            .map(({ time, i }) => `
                <div class="flex-shrink-0 w-20 text-center rounded-2xl bg-white/10 p-3">
                    <div class="text-sm text-white/80">${time.getHours()}:00</div>
                    <div class="text-2xl my-1">${codeToIcon(hourly.weather_code[i]).icon}</div>
                    <div class="font-bold">${fmt(displayUnit(hourly.temperature_2m[i]), 0)}°</div>
                    <div class="text-xs text-white/70 mt-1">💧 ${fmt(hourly.relative_humidity_2m[i], 0)}%</div>
                </div>
            `).join('');

        hourlyEl.innerHTML = `
            <div class="rounded-3xl bg-white/20 p-6 shadow-xl backdrop-blur-md fade-in">
                <h3 class="text-sm uppercase tracking-wider text-white/80 mb-4">Hourly Forecast</h3>
                <div class="flex gap-3 overflow-x-auto pb-3 -mx-6 px-6">${hourlyContent}</div>
            </div>`;
    };

    // ------------ Initialization ------------
    async function loadWeather() {
        if (!state.coords) return;
        showError('');
        setLoading(true);
        try {
            const data = await fetchWeather(state.coords.lat, state.coords.lon);
            state.data = data;
            render();
        } catch (e) {
            showError(e?.message || 'Failed to load weather data.');
        } finally {
            setLoading(false);
        }
    }
    
    (function init() {
        updateUnitBtn();
        if (state.coords) {
            loadWeather();
        } else {
            $('weatherDisplay').style.opacity = 1; // Show empty state
        }
    })();
  </script>
</body>
</html>
